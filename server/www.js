!function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=10)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("express")},function(e,t){const n={uri:"mongodb://10.235.1.35:27017,10.235.1.36:27017,10.235.1.37:27017/rd-cache",options:{useNewUrlParser:!0}},r={uri:"mongodb://10.235.1.35:27017,10.235.1.36:27017,10.235.1.37:27017/rd-cache",options:{useNewUrlParser:!0,autoIndex:!1,reconnectTries:Number.MAX_VALUE,reconnectInterval:500,poolSize:10,bufferMaxEntries:0}};e.exports={cacheServer:r,sessionServer:n,CacheClusterUris:["10.235.1.35:27017","10.235.1.36:27017","10.235.1.37:27017"],SessionClusterUris:["10.235.1.35:27017","10.235.1.36:27017","10.235.1.37:27017"]}},function(e,t,n){const r=n(2),s=n(0),o=n(15);let a=null,i={};e.exports={init:()=>new Promise(async(e,t)=>{const n={useNewUrlParser:!0,useCreateIndex:!0,useFindAndModify:!1,autoIndex:!1,reconnectTries:Number.MAX_VALUE,reconnectInterval:1e3,poolSize:20,bufferMaxEntries:0,connectTimeoutMS:3e4,socketTimeoutMS:36e4,family:4},o=r.sessionServer.uri;console.log(o),a=await s.createConnection(o,n),e()}),createIndexes:(e,t=null)=>{c(e).createIndexes(o[e].index(t||{expires:1},{expireAfterSeconds:0},{background:!0})).then().catch(e=>{log.writeFile(e,ERR_FILE_NAME),console.error(e)})},ensureIndexes:(e,t=null)=>{c(e).ensureIndexes(o[e].index(t||{expires:1},{background:!0})).then().catch(e=>{log.writeFile(e,ERR_FILE_NAME),console.error(e)})},ensureIndexes_ex:(e,t=null,n)=>{c(e).ensureIndexes(o[e].index(t||{expires:1},{expireAfterSeconds:n},{background:!0})).then().catch(e=>{log.writeFile(e,ERR_FILE_NAME),console.error(e)})},save:(e,t)=>new(c(e))(t).save().then(e=>1).catch(e=>(console.log(e),-1)),insertMany:async(e,t)=>{try{let n=c(e);return(await n.insertMany(t)).length}catch(e){return console.log(e),e}},select:(e,t)=>c(e).find(t).then(e=>e).catch(e=>(log.writeFile(e,ERR_FILE_NAME),[])),selectByPage:async(e,t,n,r,s)=>{let o=c(e);const a=await o.find(t).count();return o.find(t).sort(n).skip(r).limit(s).then(e=>[e,a]).catch(e=>(log.writeFile(e,ERR_FILE_NAME),[]))},selectTest:(e,t,n)=>c(e).find(t,n).then(e=>e).catch(e=>(log.writeFile(e,ERR_FILE_NAME),[])),selectTestByPage:async(e,t,n,r,s,o)=>{let a=c(e);const i=await a.find(t).count();return a.find(t,n).sort(r).skip(s).limit(o).then(e=>[e,i]).catch(e=>[e])},selectAndSort:(e,t,n={})=>c(e).find(t).sort(n).then(e=>e).catch(e=>(log.writeFile(e,ERR_FILE_NAME),[])),selectLastOne:(e,t)=>c(e).find(t).sort({_id:-1}).limit(1).then(e=>e).catch(e=>(log.writeFile(e,ERR_FILE_NAME),[])),selectByIdAndUpdate:(e,t,n)=>c(e).findById(t).then(e=>{if(e){for(let t in n)e[t]=n[t];return e.save().then(e=>1).catch(e=>{throw e})}return 0}).catch(e=>(log.writeFile(e,ERR_FILE_NAME),-1)),remove:(e,t)=>c(e).remove(t).then(e=>e||0).catch(e=>(console.error(e),-1)),delete:e=>c(e).deleteMany({}).then(e=>e||0).catch(e=>(console.error(e),-1)),findOneAndUpdate:(e,t,n)=>c(e).findOneAndUpdate(t,{$set:n}).then(e=>e?1:0).catch(e=>(log.writeFile(e,ERR_FILE_NAME),-1)),findOneAndUpdateOrInsert:(e,t,n)=>c(e).findOneAndUpdate(t,{$set:n},{upsert:!0,new:!0}).then(e=>e?1:0).catch(e=>(log.writeFile(e,ERR_FILE_NAME),-1)),updateMany:(e,t,n)=>c(e).updateMany(t,{$set:n},{upsert:!1,new:!0}).then(e=>e?1:0).catch(e=>(console.log(e),-1)),aggregateQUery:(e,t)=>c(e).aggregate(t).then(e=>e).catch(e=>(log.writeFile(e,ERR_FILE_NAME),-1))};const c=e=>null===a?(log.writeFile(msg.ERR3,ERR_FILE_NAME),console.error(msg.ERR3),null):(i[e]||(i[e]=a.model(e,o[e],e)),i[e])},function(e,t,n){const r=n(7).poolCluster,s=n(6);n(29);e.exports={rdInnerQuery:async function(e,t){const n=`CALL ${e} (${Array(t.length).fill("?").join(",")});`;let o=null;try{o=await new s((e,t)=>{r.getConnection((n,r)=>{n&&t(n),e(r)})})}catch(e){throw e}return await new s((e,r)=>{o.query(n,t,(t,n)=>{t&&r(t),o.release(),e(n)})})}}},function(e,t){e.exports=require("debug")},function(e,t){e.exports=require("promise")},function(e,t,n){const r={user:"swkj",password:"qwerasdf",database:"zhangyi_jls_01",charset:"utf8mb4",uris:["10.235.3.41:3306"]},s=1e4,o=!0,a=8,i=0,c=!1,d=n(14).createPoolCluster({canRetry:!0,removeNodeErrorCount:1,restoreNodeTimeout:0,defaultSelector:"RANDOM"});r.uris.forEach(e=>d.add((e=>{const[t,n]=e.split(":");return{host:t,port:n,database:r.database,user:r.user,password:r.password,charset:r.charset,acquireTimeout:s,waitForConnections:o,connectionLimit:a,queueLimit:i,multipleStatements:c}})(e))),e.exports={poolCluster:d,mysqlConfig:r}},function(e,t,n){const r=n(0),{cacheServer:s,sessionServer:o}=n(2),a=r.createConnection(o.uri,o.options,(e,t)=>{if(e)throw e;console.log("sessionDbConn OK")}),i=r.createConnection(s.uri,s.options,(e,t)=>{if(e)throw e;console.log("cacheDbConn OK")});e.exports={sessionDbConn:a,cacheDbConn:i}},function(e,t,n){let r=n(8);let s=new(0,n(0).Schema)({_id:{type:String},server:{type:String},type:{type:String},route:{type:String},description:{type:String},error:{type:String},param:{type:String},procName:{type:String},procParam:{type:String},extra:{type:String},time:{type:Date},expires:{type:Date}}),o=r.sessionDbConn.model("sourcecxschema",s);e.exports={model:o,schema:s}},function(e,t,n){n(11);const r=n(5)("express:sdr");r("Application booting");const s=function(e){let t=parseInt(e,10);if(isNaN(t))return e;if(t>=0)return t;return!1}(process.env.PORT||"3001");n(12).then((function(){n(17).createServer(n(18)).listen(s,"0.0.0.0").on("error",e=>{throw e}).on("listening",()=>{r("APP has been started successfully!"),console.log("APP has been started successfully!"),console.log("Listening on "+s)}).on("exit",()=>{console.log("On exit!!!")})}))},function(e,t){e.exports=require("colors")},function(e,t,n){const r=n(6),s=n(5)("express:sdr"),o=n(13),a=(n(2),n(7)),i=n(3),c=new r(e=>{r.all(a.mysqlConfig.uris.map(e=>new r(t=>{n(16).createConnection(...e.split(":").reverse()).on("connect",()=>{s(`[MYSQLDB NODE]@${e} IS UP!`.green),console.log(`[MYSQLDB NODE]@${e} IS UP!`),t(1)}).on("error",()=>{s(`[MYSQLDB NODE]@${e} IS DOWN!`.red),t(0)})}))).then(t=>{t.every(e=>0===e)&&(console.log("[MYSQLDB CLUSTER] HAS NO NODE CAN BE USED!".red),process.exit(0)),o.isDebug&&console.log("[MYSQLDB CLUSTER] IS STAND BY!".green),e()})}),d=new r(e=>{i.init().then(()=>{console.log("[SESSION SERVER] has been detected!"),e()}).catch(e=>console.log(e))});e.exports=new r(e=>{s("#############Detecting Dependency Servers############".red),r.all([c,d]).then(()=>{s("##########Dependency Server Detect Completely########\n".red),e()})}).catch(e=>{console.log(e)})},function(e,t,n){const r="production"===n(1)().get("env");e.exports={nodeServer:{address:"127.0.0.1",port:"5112"},messageServer:{host:"127.0.0.1",port:"3457"},isDebug:r}},function(e,t){e.exports=require("mysql")},function(e,t,n){const r=n(0).Schema;let s=new r({_id:{type:String},deptCode:{type:String},deptalterCode:{type:String},doctorCode:{type:String},deptName:{type:String},doctorName:{type:String},hreCode:{type:String},qrText:{type:String}}),o=new r({_id:{type:String},deptCode:{type:String},deptalterCode:{type:String},deptName:{type:String},hreCode:{type:String},qrText:{type:String}}),a=new r({_id:{type:String},towername:{type:String},deptname:{type:String},placename:{type:String},tracktime:{type:Date},visitorname:{type:String},visitoridnum:{type:String},phonnum:{type:String},address:{type:String},abroad:{type:String},actiontrackid:{type:Number},questionid:{type:Number}});const i=new r({_id:{type:String},description:{type:String},time:{type:Date},params:{type:Object},result:{type:Object},extra:{type:Object}}),c=new r({_id:{type:String},appId:{type:String},mch_id:{type:String},trade_no:{type:String},out_trade_no:{type:String},cost:{type:Number},idNum:{type:String},name:{type:String},payType:{type:String},hospitalCode:{type:String},hosAreaCode:{type:String},doctorCode:{type:String},date:{type:String},choosenTime:{type:String},openId:{type:String},registNum:{type:String},hisOrderID:{type:String},uid:{type:String},vid:{type:String},refund:{type:Boolean},createTime:{type:Date},syncTime:{type:Date},asyncTime:{type:Date},queryTime:{type:Date},refundTime:{type:Date},refundAsyncTime:{type:Date},detail:[i]}),d=new r({_id:{type:String},registNum:{type:String},hisOrderID:{type:String},appId:{type:String},mch_id:{type:String},trade_no:{type:String},out_trade_no:{type:String},cost:{type:Number},payType:{type:String},hospitalCode:{type:String},hosAreaCode:{type:String},openId:{type:String},uid:{type:String},vid:{type:String},refund:{type:Boolean},createTime:{type:Date},syncTime:{type:Date},asyncTime:{type:Date},queryTime:{type:Date},refundTime:{type:Date},refundAsyncTime:{type:Date},detail:[i]}),p=new r({_id:{type:String},registNum:{type:String},orderNumber1:{type:String},orderNumber2:{type:String},orderNumber3:{type:String},appId:{type:String},mch_id:{type:String},hisOrderID:{type:String},trade_no:{type:String},out_trade_no:{type:String},cost:{type:Number},payType:{type:String},hospitalCode:{type:String},hosAreaCode:{type:String},openId:{type:String},uid:{type:String},vid:{type:String},refund:{type:Boolean},createTime:{type:Date},syncTime:{type:Date},asyncTime:{type:Date},queryTime:{type:Date},refundTime:{type:Date},refundAsyncTime:{type:Date},detail:[i]}),u=new r({_id:{type:String},appId:{type:String},mch_id:{type:String},trade_no:{type:String},refund_id:{type:String},out_trade_no:{type:String},cashRefundFee:{type:Number},cashFee:{type:Number},totalFee:{type:Number},refundFee:{type:Number},sendBackFee:{type:Number},insuranceRefundFee:{type:Number},couponRefundCount:{type:Number},couponRefundFee:{type:Number},payType:{type:String},refundTime:{type:Date},detail:[i]}),l=new r({appId:{type:String},mch_id:{type:String},trade_no:{type:String},out_trade_no:{type:String},ybCost:Number,selfPayCost:Number,totalCost:{type:Number,default:0},ybRefundCost:{type:Number,default:0},selfPayRefundCost:{type:Number,default:0},totalRefundCost:{type:Number,default:0},payType:{type:String},openId:{type:String},registNum:{type:String},hisOrderID:{type:String},paymentType:{type:String},createTime:{type:Date},syncTime:{type:Date},asyncTime:{type:Date},queryTime:{type:Date},refundTime:{type:Date},refundAsyncTime:{type:Date},billStatus:{type:Number,default:0},hisStatus:{type:Number,default:0},businssType:{type:String},searchDay:String}),y=new r({out_trade_no:String,ybCost:Number,selfPayCost:Number,cost:Number,ybRefundCost:Number,selfRefundCost:Number,totalRefundCost:Number,tranState:String,shoufeiId:String,orderTime:Date,syncTime:Date,refundState:String,payType:String,dzStatus:{type:Number,default:0},productName:String,searchDay:String}),g=new r({dzDate:String,systemTotal:Number,weChatTotal:Number,alipayTotal:Number,hisTotal:Number});e.exports={HopitalizedRegDoctorQRCodeData:s,HopitalizedRegDeptQRCodeData:o,TrackRegisterInfoSchema:a,LogPayment_Reg_Schema:c,LogPayment_HospitalRecall_Schema:d,LogPayment_Payment_Schema:p,dzDetailSchema:l,dzStatus:g,bills:y,LogPayment_Refund_Schema:u}},function(e,t){e.exports=require("net")},function(e,t){e.exports=require("http")},function(e,t,n){const r=n(1)(),s=n(19),o=n(20),a=n(21),i=n(22),c=n(23),d=n(24)(a);r.all("*",(e,t,n)=>{t.header("Access-Control-Allow-Origin",e.headers.origin),t.header("Access-Control-Allow-Credentials","true"),t.header("Access-Control-Allow-Methods","GET,POST,OPTIONS"),t.header("Access-Control-Allow-Headers","Content-Type"),t.header("Access-Control-Max-Age","3600"),n()}),r.use(s()),r.use(o(n(25))),r.use(a(c.session(d))),r.use(n(26)(c.secret)),r.use(i.urlencoded({extended:!1})),r.use(i.json()),n(27)(r),r.use((e,t,n)=>{const r=new Error("Not Found"+e.url+"?");r.status=404,t.json({respCode:"404"}),n(r)}),r.use((e,t,n)=>{n.locals.message=e.message,n.locals.error="development"===t.app.get("env")?e:{},n.end("error")}),e.exports=r},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("body-parser")},function(e,t,n){const{sessionServer:r}=n(2);e.exports={secret:"qwerasdf",session:e=>({resave:!1,saveUninitialized:!1,rolling:!0,key:"source~",cookie:{path:"/",httpOnly:!0,secure:!1,maxAge:18e5},secret:"qwerasdf",store:new e({url:r.uri,stringify:!1})})}},function(e,t){e.exports=require("connect-mongo")},function(e,t){e.exports={origin:["http://localhost:5600","https://yc-42.jlumc.net","http://localhost:5905"],methods:["GET","PUT","POST","HEAD","PATCH","DELETE","OPTIONS"],credentials:!0,proxy:!0}},function(e,t){e.exports=require("cookie-parser")},function(e,t,n){e.exports=e=>{e.options("/",(e,t)=>t.status(200).end()),e.get("/",(e,t)=>{t.status(404).end()});e.use("/source-system/login",n(28)),e.use("/source-source/source",n(31)),e.use("/source-dz",n(33))}},function(e,t,n){const r=n(1).Router(null),s=n(4),o=n(8),a=n(30),i=(e,t)=>{t.json({respCode:e})};r.post("/login1",(e,t)=>{const n=e.body,r=[n.uid,n.password],c=new Array(0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z");let d="";s.rdInnerQuery("m_PCLogin",r).then(n=>{if(console.log(n),n[0][0].rtnMsg)t.json({respData:{status:"1"},respResultsets:[n[0][0].rtnMsg],respCode:"200"});else{let s=o.sessionDbConn.model("sourcecxschema");try{s.find({description:n[0][0].creditCode}).then(s=>{if(!s&&s.length>0){e.session.uid=n[0][0].creditCode;let r=(new Date).getHours(),s=(new Date).getMinutes();for(var i=0;i<5;i++){var p=Math.floor(36*Math.random());d+=c[p]}e.session.rangeStr=`${r<0?"0"+r:r}${s<0?"0"+s:s}${d}`,o.sessionDbConn.model("sourcecxschema").deleteMany({description:e.session.uid}).then(e=>{t.json({respData:{status:"2"},respResultsets:n,respCode:"200"})})}else{e.session.uid=n[0][0].creditCode;let s=(new Date).getHours(),o=(new Date).getMinutes();for(i=0;i<5;i++){p=Math.floor(36*Math.random());d+=c[p]}e.session.rangeStr=`${s<0?"0"+s:s}${o<0?"0"+o:o}${d}`,a.save("loginSession","source/login",n[0][0].creditCode,"","","m_PCLogin",r.join(","),e.session.rangeStr),t.json({respData:{status:"0"},respResultsets:n,respCode:"200"})}}).catch(e=>{console.log(e)})}catch(e){console.log(e)}}}).catch(e=>{console.log(e),i("e503",t)})}),r.post("/",(e,t)=>{const n=e.body,r=[n.uid,n.password];new Array(0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z");s.rdInnerQuery("m_PCLogin",r).then(e=>{e[0][0].rtnMsg?t.json({respData:{status:"1"},respResultsets:[e[0][0].rtnMsg],respCode:"200"}):(console.log(e),t.json({respData:{status:"0"},respResultsets:e,respCode:"200"}))}).catch(e=>{console.log(e),i("e503",t)})}),r.get("/logout",(e,t)=>{e.session?o.sessionDbConn.model("sourcecxschema").deleteMany({description:e.session.uid}).then(e=>{console.log(e),t.json({respData:{},respResultset:[],respCode:"200"})}):t.json({respData:{},respResultset:[],respCode:"200"})}),r.get("/test",(e,t)=>{t.json("SUCCESS")}),e.exports=r},function(e,t){const n=-128,r=127,s=-32768,o=32767,a=-2147483648,i=2147483647,c=-0x802386f26fc10000,d=0x8000000000000000,p="1970-01-01 00:00:00",u="2038-01-19 11:14:07",l="1000-01-01",y="9999-12-31",g="00:00:00",m="838:59:59",f=e=>"number"==typeof e&&!isNaN(e)&&(e>n&&e<r),h=e=>"number"==typeof e&&!isNaN(e)&&(e>s&&e<o),S=e=>"number"==typeof e&&!isNaN(e)&&(e>c&&e<d),b=(e,t)=>"string"==typeof e&&"number"==typeof t&&!isNaN(t)&&e.length<=t,C=(e,t)=>b(e,t),_=e=>/^\d{4}-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01]) ([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/.test(e)&&e>=p&&e>=u,D=e=>/^\d{4}-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])$/.test(e)&&e>=l&&e>=y,R=e=>/^([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/.test(e)&&e>=g&&e>=m;e.exports={test:(e,t)=>{if(!Array.isArray(e)||!Array.isArray(t)||e.length!==t.length)return!1;for(let r=0,s=e.length;r<s;r++)switch(t[r].paramType){case"varchar":if(!b(e[r],t[r].paramMaxLen))return!1;break;case"int":if(!("number"==typeof(n=e[r])&&!isNaN(n)&&n>a&&n<i))return!1;break;case"tinyint":if(!f(e[r]))return!1;break;case"smallint":if(!h(e[r]))return!1;break;case"char":if(!C(e[r],t[r].paramMaxLen))return!1;break;case"bigint":if(!S(e[r]))return!1;break;case"timestamp":if(!_(e[r]))return!1;break;case"date":if(!D(e[r]))return!1;break;case"time":if(!R(e[r]))return!1;break;default:return!1}var n;return!0}}},function(e,t,n){const r=n(9);e.exports={save:(e,t,n,s,o,a,i,c)=>{new r.model({_id:(new Date).getTime()+Math.random().toString(10).substr(2,10),time:new Date+"",type:e,description:n,route:t,error:s,param:String(o),procName:a,procParam:String(i),extra:String(c||"")}).save((function(e,t){}))}}},function(e,t,n){const r=n(1).Router(null),s=n(4),o=n(3),{model:a,model1:i,schema:c}=n(9),d=(e,t)=>{t.json({respCode:e,errmsg:t})};n(32);r.post("/KS",(e,t)=>{const n=[e.body.KSId,e.body.date,1*e.body.pageIndex];s.rdInnerQuery("proc_zy_gettrackbydate",n).then(e=>{t.json({respData:{status:"0",dataLength:e[0].length},respResultsets:e,respCode:"200"})}).catch(e=>{console.log(e),d("e503",t)})}),r.post("/v2/KS",async(e,t)=>{let n=null;const r=new Date(e.body.date+" 00:00:00").getTime(),s=r+864e5,a={$gte:new Date(r),$lt:new Date(s)},i={towername:1,deptname:1,placename:1,tracktime:-1},c=10*(e.body.pageIndex-1);n=e.body.KSId?await o.selectByPage("TrackRegisterInfoSchema",{tracktime:a,deptname:e.body.KSId},i,c,e.body.pageSize||10):await o.selectByPage("TrackRegisterInfoSchema",{tracktime:a},i,c,e.body.pageSize||10),t.json({respData:{status:"0",dataLength:n[1]},respResultsets:n[0],respCode:"200"})}),r.post("/v2/person",async(e,t)=>{o.select("TrackRegisterInfoSchema",{visitoridnum:e.body.id}).then(e=>{t.json({respData:{status:"0",dataLength:e.length},respResultsets:e,respCode:"200"})})}),r.post("/KS-hot",(e,t)=>{console.log("1111");const n=[e.body.beginDate,e.body.endDate,"3001"];s.rdInnerQuery("proc_zy_getquestioninfo_td",n).then(e=>{t.json({respData:{status:"0",dataLength:e[0].length},respResultsets:e,respCode:"200"})}).catch(e=>{console.log(e),d("e503",t)})}),r.post("/remark",(e,t)=>{const n=[e.body.questionId,e.body.remark];s.rdInnerQuery("proc_zy_updatequestioninfo",n).then(e=>{t.json({respData:{status:"0",dataLength:"0"},respResultsets:e,respCode:"200"})}).catch(e=>{console.log(e),d("e503",t)})}),r.get("/KS-hot",(e,t)=>{const n=[e.query.beginDate,e.query.endDate,"3001"];s.rdInnerQuery("proc_zy_getquestioninfo_td",n).then(e=>{t.json({respData:{status:"0",dataLength:e[0].length},respResultsets:e,respCode:"200"})}).catch(e=>{console.log(e),d("e503",t)})}),r.post("/emergency",(e,t)=>{const n=[e.body.beginDate,e.body.endDate,"1017","88"];s.rdInnerQuery("proc_zy_getquestioninfo_tdy",n).then(e=>{t.json({respData:{status:"0",dataLength:e[0].length},respResultsets:e,respCode:"200"})}).catch(e=>{console.log(e),d("e503",t)})}),r.post("/payment_area",(e,t)=>{const n=[e.body.beginDate,e.body.endDate,"4001",e.body.para_inhosward,e.body.condition];console.log(n),s.rdInnerQuery("proc_zy_getquestioninfo_inhos",n).then(e=>{t.json({respData:{status:"0",dataLength:e[0].length},respResultsets:e,respCode:"200"})}).catch(e=>{console.log(e),d("e503",t)})}),r.post("/revoke",(e,t)=>{const n=[e.body.questionId];s.rdInnerQuery("proc_zy_repealquestion",n).then(e=>{t.json({respData:{status:"0",dataLength:0},respResultsets:e,respCode:"200"})}).catch(e=>{console.log(e),d("e503",t)})}),r.post("/person",(e,t)=>{const n=[e.body.IDCard];s.rdInnerQuery("proc_zy_gettrackbyperson",n).then(e=>{t.json({respData:{status:"0",dataLength:e[0].length},respResultsets:e,respCode:"200"})}).catch(e=>{console.log(e),d("e503",t)})}),r.post("/qrCodeList",(e,t)=>{o.select("HopitalizedRegDoctorQRCodeData").then(e=>{t.json({respData:{status:"0",dataLength:e.length},respResultsets:e,respCode:"200"})})}),r.post("/qrCodeList1",(e,t)=>{o.select("HopitalizedRegDeptQRCodeData").then(e=>{t.json({respData:{status:"0",dataLength:e.length},respResultsets:e,respCode:"200"})})}),r.post("/test",(e,t)=>{const n=JSON.stringify({signIn:{opter_no:"4453511",mac:"yHi0eAtYCGtAyxn+bReUNhcOHkQDFLXVfv5EegMCv0w=",ip:"10.1.1.39"}}),r='{"signIn":{"opter_no":"4453511","mac":"yHi0eAtYCGtAyxn+bReUNhcOHkQDFLXVfv5EegMCv0w=","ip":"10.1.1.39"}}';console.log("string"),t.send(n===r)}),e.exports=r},function(e,t,n){let r=n(0),s=new(0,r.Schema)({_id:{type:String},towername:{type:String},deptname:{type:String},placename:{type:String},tracktime:{type:Date},visitorname:{type:String},visitoridnum:{type:String},phonnum:{type:String},address:{type:String},abroad:{type:String},actiontrackid:{type:Number},questionid:{type:Number}}),o=r.model("TrackRegisterInfoSchema",s,"TrackRegisterInfoSchema");e.exports={model:o,schema:s,find:async function(e,t,n){try{if(!t||""==t)throw"日期为空";if(!n||n<1)throw"页码为空";let r=[],s=0;const a=new Date(t+" 00:00:00").getTime(),i={$gte:a,$lt:a+864e5},c={towername:1,deptname:1,placename:1,tracktime:-1},d=10*(n-1);return e&&""!==e?(r=await o.find({tracktime:i,deptname:e}).sort(c).skip(d).limit(10).exec(),s=await o.find({tracktime:i,deptname:e}).count()):(r=await o.find({tracktime:i}).sort(c).skip(d).limit(10).exec(),s=await o.find({tracktime:i}).count()),[r,{maxrows:s}]}catch(e){return[[],[{maxrows:0}]]}},findById:async function(e){try{if(!e||""==e)throw"参数错误";const t={tracktime:-1};return[await o.find({visitoridnum:e}).sort(t).exec()]}catch(e){return[[]]}}}},function(e,t,n){const r=n(1).Router(null),s=(n(0),n(3));n(4);async function o(e){const t=await s.select("dzDetailSchema",{searchDay:e.substr(0,10)}),n=await s.select("bills",{searchDay:e.substr(0,10),payType:{$ne:"his"}});for(let e=0;e<t.length;e++){const r=n.filter(n=>t[e].out_trade_no===n.out_trade_no&&n.tranState===t[e].paymentType);if(r.length>0){let n=0;"SUCCESS"===t[e].paymentType?n=t[e].totalCost/100===r[0].cost?1:-1:"REFUND"===t[e].paymentType&&(n=t[e].totalRefundCost/100===r[0].totalRefundCost&&t[e].ybRefundCost/100===r[0].ybRefundCost&&t[e].selfPayRefundCost/100===r[0].selfRefundCost?1:-1),await s.findOneAndUpdate("dzDetailSchema",{_id:t[e]._id},{billStatus:n})}}}async function a(e){const t=[{$match:{payType:"his",tranState:"SUCCESS",searchDay:e.substr(0,10)}},{$group:{_id:"$out_trade_no",cost:{$sum:"$cost"},tranState:{$first:"$tranState"}}}],n=await s.select("dzDetailSchema",{searchDay:e.substr(0,10)}),r={};r.SUCCESS=await s.aggregateQUery("bills",t),r.REFUND=await s.select("bills",{searchDay:e.substr(0,10),payType:"his",tranState:"REFUND"});for(let e=0;e<n.length;e++){const t=r[n[e].paymentType].filter(t=>"REFUND"===n[e].paymentType?n[e].out_trade_no===t.out_trade_no:n[e].out_trade_no===t._id);if(t.length>0){let r=0;"SUCCESS"===n[e].paymentType?r=n[e].totalCost/100===t[0].cost?1:-1:"REFUND"===n[e].paymentType&&(r=n[e].totalRefundCost/100===t[0].totalRefundCost&&n[e].selfPayRefundCost/100===t[0].selfRefundCost?1:-1),await s.findOneAndUpdate("dzDetailSchema",{_id:n[e]._id},{hisStatus:r})}}}async function i(e){const t=await s.select("dzDetailSchema",{searchDay:e.substr(0,10)}),n=await s.select("bills",{searchDay:e.substr(0,10),payType:{$ne:"his"}});for(let e=0;e<n.length;e++){const r=t.filter(t=>t.out_trade_no===n[e].out_trade_no&&n[e].tranState===t.paymentType);if(r.length>0){let t=0;"SUCCESS"===n[e].tranState?t=n[e].cost===r[0].totalCost/100:"REFUND"===n[e].tranState&&(t=n[e].ybRefundCost===r[0].ybRefundCost/100&&n[e].selfRefundCost===r[0].selfPayRefundCost/100&&n[e].totalRefundCost===r[0].totalRefundCost/100?1:-1),await s.findOneAndUpdate("bills",{_id:n[e]._id},{dzStatus:t})}}}async function c(e){const t=[{$match:{payType:"his",searchDay:e.substr(0,10),tranState:"SUCCESS"}},{$group:{_id:"$out_trade_no",cost:{$sum:"$cost"},ids:{$push:"$_id"},tranState:{$first:"$tranState"},ybCost:{$sum:"$ybCost"},selfPayCost:{$sum:"$selfPayCost"},ybRefundCost:{$sum:"$ybRefundCost"},selfRefundCost:{$sum:"$selfRefundCost"},totalRefundCost:{$sum:"$totalRefundCost"}}}],n=await s.select("dzDetailSchema",{searchDay:e.substr(0,10)}),r=await s.aggregateQUery("bills",t);for(let e=0;e<r.length;e++){const t=n.filter(t=>t.out_trade_no===r[e]._id&&r[e].tranState===t.paymentType);if(t.length>0){const n=r[e].cost===t[0].totalCost/100;1===r[e].ids.length?await s.findOneAndUpdate("bills",{_id:r[e].ids[0]},{dzStatus:n}):r[e].ids.length>1&&await s.updateMany("bills",{_id:{$in:r[e].ids}},{dzStatus:n})}}}async function d(e){const t=[{$match:{payType:"his",searchDay:e.substr(0,10),tranState:"REFUND"}},{$group:{_id:"$out_trade_no",cost:{$sum:"$cost"},ids:{$push:"$_id"},tranState:{$first:"$tranState"},ybCost:{$sum:"$ybCost"},selfPayCost:{$sum:"$selfPayCost"},ybRefundCost:{$sum:"$ybRefundCost"},selfRefundCost:{$sum:"$selfRefundCost"},totalRefundCost:{$sum:"$totalRefundCost"}}}],n=await s.select("dzDetailSchema",{searchDay:e.substr(0,10)}),r=await s.aggregateQUery("bills",t);for(let e=0;e<r.length;e++){const t=n.filter(t=>t.out_trade_no===r[e]._id&&r[e].tranState===t.paymentType);if(t.length>0){const n=r[e].ybRefundCost===t[0].ybRefundCost/100&&r[e].selfRefundCost===t[0].selfPayRefundCost/100&&r[e].totalRefundCost===t[0].totalRefundCost/100?1:-1;1===r[e].ids.length?await s.findOneAndUpdate("bills",{_id:r[e].ids[0]},{dzStatus:n}):r[e].ids.length>1&&await s.updateMany("bills",{_id:{$in:r[e].ids}},{dzStatus:n})}}}r.post("/getDetail",async(e,t)=>{const n=e.body.date;await Promise.all([await o(n),await a(n)]),await Promise.all([await i(n),await c(n),await d(n)]),t.json("11111111111111111111111111111111111111111111")}),e.exports=r}]);