!function(e){var n={};function t(o){if(n[o])return n[o].exports;var r=n[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,t),r.l=!0,r.exports}t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:o})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(t.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var r in e)t.d(o,r,function(n){return e[n]}.bind(null,r));return o},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=5)}([function(e,n,t){e.exports={corsConfig:{origin:["http://192.168.2.208","http://localhost:5900","http://localhost:5900","http://localhost:5905","http://localhost:5600","http://localhost:8100"],methods:["GET","PUT","POST","HEAD","PATCH","DELETE","OPTIONS"],credentials:!0,proxy:!0},nodeServer:{address:"",port:"3001"},CacheClusterUris:["mongodb://10.199.4.22:27017,10.199.4.23:27017,10.199.4.24:27017/yb_session_test?replicaSet=my_repl"],SessionClusterUris:["mongodb://10.199.4.22:27017,10.199.4.23:27017,10.199.4.24:27017/yb_session_test?replicaSet=my_repl"],sessionServer:{uri:["mongodb://10.199.4.22:27017,10.199.4.23:27017,10.199.4.24:27017/yb_session_test?replicaSet=my_repl"],options:{useNewUrlParser:!0}},cacheServer:{uri:["mongodb://10.199.4.22:27017,10.199.4.23:27017,10.199.4.24:27017/yb_session_test?replicaSet=my_repl"],options:{useNewUrlParser:!0,autoIndex:!1,reconnectTries:Number.MAX_VALUE,reconnectInterval:500,poolSize:10,bufferMaxEntries:0}},oracledb:{queueRequests:!0,autoCommit:!1,poolIncrement:1,poolMax:0,poolMin:5,poolPingInterval:60,poolTimeout:60,queueTimeout:0},poolAttrs:{connectionString:"10.199.4.26:1521/orcl",user:"ccsyb",password:"ccsyb",poolIncrement:1,homogeneous:!0},imgs:"data/img/",isDebug:"production"===t(1)().get("env")}},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("debug")},function(e,n,t){const o=t(0),r=t(4),i=t(9);let s=null,c={};e.exports={init:()=>new Promise((e,n)=>{const t={useNewUrlParser:!0,useCreateIndex:!0,useFindAndModify:!1,autoIndex:!1,reconnectTries:Number.MAX_VALUE,reconnectInterval:1e3,poolSize:20,bufferMaxEntries:0,connectTimeoutMS:3e4,socketTimeoutMS:36e4,family:4},i=o.CacheClusterUris[0];r.createConnection(i,t).then(n=>{s=n,e()}).catch(e=>n(e))}),createIndexes:(e,n=null)=>{a(e).createIndexes(i[e].index(n||{expires:1},{expireAfterSeconds:0},{background:!0})).then().catch(e=>{log.writeFile(e,ERR_FILE_NAME),console.error(e)})},ensureIndexes:(e,n=null)=>{a(e).ensureIndexes(i[e].index(n||{expires:1},{background:!0})).then().catch(e=>{log.writeFile(e,ERR_FILE_NAME),console.error(e)})},ensureIndexes_ex:(e,n=null,t)=>{a(e).ensureIndexes(i[e].index(n||{expires:1},{expireAfterSeconds:t},{background:!0})).then().catch(e=>{log.writeFile(e,ERR_FILE_NAME),console.error(e)})},save:(e,n)=>new(a(e))(n).save().then(e=>1).catch(t=>(log.writeFile(e+"---"+JSON.stringify(n),ERR_FILE_NAME).then(e=>{log.writeFile(t,ERR_FILE_NAME).then()}),-1)),insertMany:async(e,n)=>{try{let t=a(e);return(await t.insertMany(n)).length}catch(n){return log.writeFile(e,ERR_FILE_NAME).then(e=>{log.writeFile(n,ERR_FILE_NAME).then()}),n}},select:(e,n)=>a(e).find(n).then(e=>e).catch(e=>(log.writeFile(e,ERR_FILE_NAME),[])),selectTest:(e,n,t)=>a(e).find(n,t).then(e=>e).catch(e=>(log.writeFile(e,ERR_FILE_NAME),[])),selectAndSort:(e,n,t={})=>a(e).find(n).sort(t).then(e=>e).catch(e=>(log.writeFile(e,ERR_FILE_NAME),[])),selectLastOne:(e,n)=>a(e).find(n).sort({_id:-1}).limit(1).then(e=>e).catch(e=>(log.writeFile(e,ERR_FILE_NAME),[])),selectByIdAndUpdate:(e,n,t)=>a(e).findById(n).then(e=>{if(e){for(let n in t)e[n]=t[n];return e.save().then(e=>1).catch(e=>{throw e})}return 0}).catch(e=>(log.writeFile(e,ERR_FILE_NAME),-1)),remove:(e,n)=>a(e).remove(n).then(e=>e||0).catch(e=>(console.error(e),-1)),delete:e=>a(e).deleteMany({}).then(e=>e||0).catch(e=>(console.error(e),-1)),findOneAndUpdate:(e,n,t)=>a(e).findOneAndUpdate(n,{$set:t},{upsert:!1,new:!0}).then(e=>e?1:0).catch(e=>(log.writeFile(e,ERR_FILE_NAME),-1)),findOneAndUpdateOrInsert:(e,n,t)=>a(e).findOneAndUpdate(n,{$set:t},{upsert:!0,new:!0}).then(e=>e?1:0).catch(e=>(log.writeFile(e,ERR_FILE_NAME),-1)),updateMany:(e,n,t)=>a(e).updateMany(n,{$set:t},{upsert:!1,new:!0}).then(e=>e?1:0).catch(e=>(log.writeFile(e,ERR_FILE_NAME),-1))};const a=e=>null===s?(log.writeFile(msg.ERR3,ERR_FILE_NAME),console.error(msg.ERR3),null):(c[e]||(c[e]=s.model(e,i[e])),c[e])},function(e,n){e.exports=require("mongoose")},function(e,n,t){t(6),t(2)("express:sdr")("Application booting");const o=t(0),r=o.nodeServer.port,i=o.nodeServer.address;try{t(7).then((function(){t(11).createServer(t(12)).listen(r,i).on("error",e=>{throw e}).on("listening",()=>{console.log("APP has been started successfully!"),console.log("Listening on "+r)}).on("exit",()=>{console.log("On exit!!!")})}))}catch(e){console.log(e)}},function(e,n){e.exports=require("colors")},function(e,n,t){const o=t(8);t(2)("express:sdr"),t(3);t(10).MongoClient;t(0);e.exports=new o(e=>{console.log("#############Detecting Dependency Servers############"),o.all([]).then(()=>{console.log("##########Dependency Server Detect Completely########\n"),e()})})},function(e,n){e.exports=require("promise")},function(e,n,t){const o=t(4).Schema,r=new o({key:String,value:String,expires:Date}),i=new o({code:String,unionid:String,status:String,tel:String,createdAt:{type:Date,expires:30}}),s=new o({creditCode:String,chainName:String}),c=new o({bindId:String,bindName:String}),a=new o({organId:String,organName:String,year:String,January:String,February:String,March:String,April:String,May:String,June:String,July:String,August:String,September:String,October:String,November:String,December:String}),l=new o({_id:String,session:Object,expires:Date}),u=new o({geRenBh:String,jiaTingBh:String,xingMing:String,shenFenZh:String,tel:String,email:String,canBaoLx:String,canBaoZt:String,canBaoDw:String,shiYongBz:String,renYuanLbBm:String,renYuanLbMc:String,color1:String,color2:String,zuoFeiBz:String,unionid:String,bindId:String,threadId:String,openid:String,ybUserId:String,selfSign:String,workDate:String,expires:Date}),g=new o({creditCode:String,organName:String,pharmacistName:String,pharmacistIDCard:String,status:String}),d=new o({creditCode:String,name:String,address:String,member:String,setDate:String,scope:String}),p=new o({geRenBh:String,jiaTingBh:String,xingMing:String,shenFenZh:String,tel:String,mobile:String,yiBaoBh:String,email:String,canBaoLx:String,canBaoZt:String,canBaoDw:String,danWeiBh:String,empEnttCodg:String,shiYongBz:String,renYuanLbBm:String,renYuanLbMc:String,color1:String,color2:String,zuoFeiBz:String,unionid:String,openid:String,bindId:String,threadId:String,ybUserId:String,workDate:String,insuAdmdvs:String,poolareaNo:String,crtInsuDate:String,psnInsuRltsId:String,selfSign:String,auth_code:String,channel:String,create_time:String,update_time:String,is_delete:String});e.exports={pharmacistInfo:g,qrCodeCcsyb:i,userInfo:u,organInfo:d,chainCodeInfo:s,bindOrgan:c,voucher:a,ldjgsession:l,sysParams:r,pub_user_info:p}},function(e,n){e.exports=require("mongodb")},function(e,n){e.exports=require("http")},function(e,n,t){const o=t(1)(),r=t(13),i=t(14),s=t(15),c=t(16),a=t(17),l=(t(18)(c),t(0));o.use(r()),o.use(i(l.corsConfig)),o.use(t(19)(a.secret)),o.use(s.urlencoded({limit:"50mb",extended:!1})),o.use(s.json({limit:"50mb"})),t(20)(o),o.use((e,n,t)=>{console.log(e.url),console.log(e.method);const o=new Error("Not Found"+e.url+"?");o.status=404,n.json({respCode:"404"}),t(o)}),o.use((e,n,t)=>{t.locals.message=e.message,t.locals.error="development"===n.app.get("env")?e:{},t.end("error")}),e.exports=o},function(e,n){e.exports=require("helmet")},function(e,n){e.exports=require("cors")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("express-session")},function(e,n){e.exports={resave:!1,saveUninitialized:!1,rolling:!0,key:"booom",secret:"qwerasdf",cookie:{path:"/",httpOnly:!0,secure:!1,maxAge:6e5}}},function(e,n){e.exports=require("connect-mongo")},function(e,n){e.exports=require("cookie-parser")},function(e,n,t){e.exports=e=>{e.options("/",(e,n)=>n.status(200).end()),e.get("/",(e,n)=>{n.status(404).end()});e.use("/socket-test",t(21))}},function(e,n,t){const o=t(1).Router(null),r=t(3),i=t(22),s=t(24),c={};let a=null;new(0,s.Server)({port:443}).on("connection",(function(e){a=e,console.log("[SERVER] connection()"),e.on("message",(function(n){c[n]=e})),e.on("close",(function(e){console.log("[SERVER] close()")}))})),o.post("/sendMsg",(e,n)=>{let t={uuid:"OEV7Q1GFPUXG0YX1R6UBLLRBSQZA",unionid:"oEv7q1GFpUXg0YX1R6UBllRbsqzA",state:"1",status:"D",name:"吕辰西",phone:"15671551894",IDCard:"220322199611126312",organName:"吕晨曦大药房",authority:"001|002|003|004|005|006|007|008|009|010|011|012|013",scope:"in",isChain:"0",chainCode:null};a.send(JSON.stringify(t)),n.json(t)}),o.post("/sendLoginInfo",(e,n)=>{const t=JSON.parse(e.body.data),o={};o.unionid=i.inputParamsVal(t.unionid),o.name=i.inputParamsVal(t.xingMing),o.phone=i.inputParamsVal(t.tel),i.executeProcedure("REGISTER_USER",o,i.outputParamsCursor(2)).then(async e=>{if("1"==e[1][0][0]){const o=new RegExp(`^.*"unionid":"${t.unionid}","loginStatus":"ldjg".*$`);await r.remove("ldjgsession",{session:o});const i={};i.uuid=e[0][0][0],i.unionid=t.unionid,i.state=t.status,i.status=e[0][0][9],i.name=t.xingMing,i.phone=t.tel,i.IDCard=t.ShenFenZH,i.organName=e[0][0][1],i.authority=e[0][0][4],i.scope=e[0][0][5],i.isChain=e[0][0][6],i.chainCode=e[0][0][7],c[t.code].send(JSON.stringify(i)),n.json("SUCCESS")}})}),o.post("/sendQRCodeInfo",async(e,n)=>{const t=JSON.parse(e.body.data),o=await r.select("pharmacistInfo",{pharmacistName:t.xingMing,pharmacistIDCard:t.ShenFenZH,status:"1"}),i={};i.name=t.xingMing,i.unionid=t.unionid,i.phone=t.tel,i.IDCard=t.ShenFenZH,i.status=0===o.length?"1":"0",i.msg=0===o.length?"绑定成功！":"该人员已被其他人员绑定",c[t.code].send(JSON.stringify(i)),n.json("SUCCESS")}),o.post("/sendQRCodeInfo1",(e,n)=>{a.send(JSON.stringify({uuid:"OEV7Q1ALFXNRZU1ADUCDBS_JOLEW",unionid:"oEv7q1AlfXnrZu1adUCdbS_JolEw",status:"1",name:"李文琢",phone:"13134310281",IDCard:"220183199004177814",msg:"SUCCESS"})),n.json("111")}),o.post("/sendQRCodeInfo2",(e,n)=>{let t={uuid:e.body.unionid.toUpperCase(),unionid:e.body.unionid,status:"1",name:e.body.name,phone:e.body.phone,IDCard:e.body.IDCard,msg:"SUCCESS"};a.send(JSON.stringify(t)),n.json("111")}),o.get("/testUrl",async(e,n)=>{n.json("SUCCESS")}),o.get("/i",(e,n)=>{r.save("organInfo",{creditCode:"1",name:"1",address:"1",member:"1",setDate:"1",scope:"1"}).then(e=>{console.log(e)})}),e.exports=o},function(e,n,t){const o=t(0),r=t(23),i="-4006 连接池对象未初始化";let s=null;const c=o.oracledb,a=o.poolAttrs;r.fetchAsString=[r.CLOB];for(const e in c)r.key=c.key;function l(){return new Promise((e,n)=>{r.createPool({user:a.user,password:a.password,connectString:a.connectionString,poolIncrement:10,poolMax:90,poolMin:5,poolTimeout:60,queueTimeout:6e3}).then(n=>{s=n,console.log("[oracle pool] has been created"),e()}).catch(e=>{console.log(e),n(e)})})}function u(e){e.close({drop:!0}).then(()=>{console.log("connection closed")}).catch(e=>{log.writeFile(e,ERR_FILE_NAME)})}function g(e,n,t){let o=[],r={};for(let e in n)o.push(":"+e),r[e]=n[e];for(let e in t)o.push(":"+e),r[e]=t[e];return{plsql:`BEGIN ${e}(${o.join(",")}); END;`,params:r}}function d(e){e.release().then(()=>{console.log("connection release")}).catch(e=>{log.writeFile(e,ERR_FILE_NAME)})}l(),e.exports={inputParamsStringCollection:function(e){return{type:r.STRING,dir:r.BIND_IN,val:e}},executeProcedure:function(e,n,t){return new Promise((o,r)=>{if(null===s)return void r(i);const c=g(e,n,t);s.getConnection().then(e=>{e.execute(c.plsql,c.params).then(n=>{let i=[];for(let e in t)n.outBinds[e]&&i.push(n.outBinds[e].getRows(1e4));Promise.all(i).then(e=>{o(e)}).then(()=>{let o=[];for(let e in t)o.push(n.outBinds[e].close());Promise.all(o).then(n=>{d(e)})}).catch(n=>{console.log(n),u(e),r(n.toString())})}).catch(n=>{console.error("execute() error",n),n&&n.toString()&&n.toString().indexOf("ORA-04068")>0?s.close(5,(function(e){l().then()})):u(e),r(n.toString())})}).catch(e=>{console.error("getConnection() error",e),r(e.toString())})})},outputParamsCursor:function(e){let n={};for(let t=0;t<e;t++)n["output_"+t]={type:r.CURSOR,dir:r.BIND_OUT};return n},inputParamsVal:function(e){return{val:e}}}},function(e,n){e.exports=require("oracledb")},function(e,n){e.exports=require("ws")}]);